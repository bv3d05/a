<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Aura HTML Controlled Menu</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap');

        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: rgba(0, 0, 0, 0.5); /* Semi-transparent background */
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            color: #ffffff; /* Default text color */
        }

        .menu-container {
            width: 700px; /* Wider to accommodate more content */
            max-height: 90vh; /* Max height to prevent overflow */
            background-color: rgba(29, 31, 33, 0.95); /* Darker, slightly transparent background */
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            overflow: hidden; /* For smooth transitions and scroll */
            border: 1px solid rgba(44, 48, 52, 0.8);
            transform: scale(0.9); /* Slightly smaller by default */
            opacity: 0;
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        }

        .menu-container.show {
            transform: scale(1);
            opacity: 1;
        }

        .menu-header {
            background: linear-gradient(90deg, #00bcd4 0%, #007bb2 100%); /* Blue gradient */
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid rgba(0, 0, 0, 0.2);
            position: relative;
            z-index: 10;
        }

        .menu-header h1 {
            margin: 0;
            font-size: 28px;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            color: #fff;
        }

        .menu-tabs {
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            background-color: rgba(35, 39, 42, 0.9); /* Slightly lighter tab background */
            border-bottom: 1px solid rgba(44, 48, 52, 0.8);
        }

        .menu-tab {
            padding: 10px 20px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.6);
            transition: color 0.2s ease, background-color 0.2s ease;
            border-radius: 8px; /* Rounded tabs */
        }

        .menu-tab:hover {
            color: #fff;
            background-color: rgba(0, 0, 0, 0.1);
        }

        .menu-tab.active {
            color: #00bcd4; /* Active tab color */
            background-color: rgba(0, 0, 0, 0.2);
            font-weight: 700;
        }

        .menu-content {
            flex-grow: 1;
            padding: 15px;
            overflow-y: auto; /* Scrollable content */
            scrollbar-width: thin;
            scrollbar-color: #00bcd4 #3b4249;
        }

        .menu-content::-webkit-scrollbar {
            width: 8px;
        }

        .menu-content::-webkit-scrollbar-track {
            background: #3b4249;
            border-radius: 10px;
        }

        .menu-content::-webkit-scrollbar-thumb {
            background-color: #00bcd4;
            border-radius: 10px;
            border: 2px solid #3b4249;
        }

        .menu-category {
            display: none; /* Hide all categories by default */
        }

        .menu-category.active {
            display: block; /* Show active category */
        }

        .menu-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            margin-bottom: 5px;
            background-color: rgba(44, 48, 52, 0.7); /* Item background */
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }

        .menu-item:hover {
            background-color: rgba(58, 63, 68, 0.8); /* Darker on hover */
            transform: translateY(-2px);
        }

        .menu-item.selected {
            background-color: #00bcd4; /* Selected item highlight */
            color: #fff;
            transform: scale(1.02);
            box-shadow: 0 4px 10px rgba(0, 188, 212, 0.3);
        }

        .menu-item-label {
            font-size: 17px;
            font-weight: 400;
            color: #fff; /* White text for labels */
        }

        .menu-item-status {
            font-size: 15px;
            font-weight: bold;
            color: #00bcd4; /* Light blue for status */
        }

        /* Toggle Switch Styles */
        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 20px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #00bcd4;
        }

        input:focus + .slider {
            box-shadow: 0 0 1px #00bcd4;
        }

        input:checked + .slider:before {
            -webkit-transform: translateX(20px);
            -ms-transform: translateX(20px);
            transform: translateX(20px);
        }

        /* NEW: SkyDive Specific Styles (from previous response) */
        .menu-item.skydive-toggle-item,
        .menu-item.skydive-speed-slider,
        .menu-item.skydive-keybind {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .menu-item.skydive-toggle-item:hover,
        .menu-item.skydive-speed-slider:hover,
        .menu-item.skydive-keybind:hover {
            background-color: rgba(255, 255, 255, 0.08);
        }

        .skydive-label {
            color: #fff;
            font-weight: bold;
        }

        .skydive-value {
            color: #00bcd4; /* Light blue */
            font-weight: bold;
        }

        /* Toggle Switch Styles (re-using if you have one, or define new) */
        .skydive-switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }

        .skydive-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .skydive-slider-round {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 20px;
        }

        .skydive-slider-round:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .skydive-slider-round {
            background-color: #00bcd4;
        }

        input:focus + .skydive-slider-round {
            box-shadow: 0 0 1px #00bcd4;
        }

        input:checked + .skydive-slider-round:before {
            -webkit-transform: translateX(20px);
            -ms-transform: translateX(20px);
            transform: translateX(20px);
        }

        /* Slider Input Styles */
        .skydive-slider-input {
            width: 100px; /* Adjust width as needed */
            margin-left: 10px;
            -webkit-appearance: none;
            appearance: none;
            background: #d3d3d3;
            outline: none;
            opacity: 0.7;
            -webkit-transition: .2s;
            transition: opacity .2s;
            height: 8px;
            border-radius: 5px;
        }

        .skydive-slider-input::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #00bcd4;
            cursor: pointer;
        }

        .skydive-slider-input::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #00bcd4;
            cursor: pointer;
        }

        .skydive-key-display {
            background-color: rgba(255, 255, 255, 0.15);
            padding: 5px 10px;
            border-radius: 5px;
            color: #fff;
            font-weight: bold;
            min-width: 50px; /* To prevent flickering */
            text-align: center;
        }

        .keybind-input-active {
            border: 2px solid #00bcd4;
            animation: pulse 1s infinite alternate;
        }

        @keyframes pulse {
            from { box-shadow: 0 0 0px #00bcd4; }
            to { box-shadow: 0 0 10px #00bcd4; }
        }

    </style>
</head>
<body>
    <div class="menu-container" id="menuContainer">
        <div class="menu-header">
            <h1>AURA HTML MENU</h1>
        </div>

        <div class="menu-tabs">
            <div class="menu-tab active" data-tab="main">Self Options</div>
            <div class="menu-tab" data-tab="online">Online</div>
            <div class="menu-tab" data-tab="combat">Combat</div>
            <div class="menu-tab" data-tab="visual">Visual</div>
            <div class="menu-tab" data-tab="vehicle">Vehicle</div>
            <div class="menu-tab" data-tab="misc">Misc</div>
            <div class="menu-tab" data-tab="destructive">Destructive</div>
            <div class="menu-tab" data-tab="triggers">Event Triggers</div>
            <div class="menu-tab" data-tab="settings">Settings</div>
        </div>

        <div class="menu-content">
            <div class="menu-category active" id="main-tab">
                <div class="menu-item" data-action="fastrun_toggle">
                    <span class="menu-item-label">Fast Run</span>
                    <label class="switch">
                        <input type="checkbox" id="fastrun-toggle">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="menu-item" data-action="noclip_toggle">
                    <span class="menu-item-label">Noclip</span>
                    <label class="switch">
                        <input type="checkbox" id="noclip-toggle">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="menu-item" data-action="godmode_toggle">
                    <span class="menu-item-label">Godmode</span>
                    <label class="switch">
                        <input type="checkbox" id="godmode-toggle">
                        <span class="slider"></span>
                    </label>
                </div>

                <hr style="border: 0; border-top: 1px dashed rgba(255,255,255,0.1); margin: 15px 0;">
                <div class="menu-item skydive-toggle-item">
                    <span class="skydive-label">SkyDive Toggle</span>
                    <label class="skydive-switch">
                        <input type="checkbox" id="skydiveToggleCheckbox">
                        <span class="skydive-slider-round"></span>
                    </label>
                </div>

                <div class="menu-item skydive-speed-slider">
                    <span class="skydive-label">SkyDive Speed</span>
                    <input type="range" min="1" max="500" value="10" class="skydive-slider-input" id="skydiveSpeedSlider">
                    <span class="skydive-value" id="skydiveSpeedValue">10</span>
                </div>

                <div class="menu-item skydive-keybind">
                    <span class="skydive-label">SkyDive Keybind</span>
                    <div class="skydive-key-display" id="skydiveKeyDisplay">None</div>
                </div>
            </div>

            <div class="menu-category" id="online-tab">
                <div class="menu-item" data-action="online">
                    <span class="menu-item-label">Online Option 1</span>
                    <span class="menu-item-status">Enabled</span>
                </div>
                <div class="menu-item" data-action="online">
                    <span class="menu-item-label">Online Option 2</span>
                    <span class="menu-item-status">Disabled</span>
                </div>
            </div>

            <div class="menu-category" id="combat-tab">
                <div class="menu-item" data-action="combat">
                    <span class="menu-item-label">Combat Option 1</span>
                    <span class="menu-item-status">Ready</span>
                </div>
            </div>

            <div class="menu-category" id="visual-tab">
                <div class="menu-item" data-action="visual">
                    <span class="menu-item-label">Visual Option 1</span>
                    <span class="menu-item-status">Active</span>
                </div>
            </div>

            <div class="menu-category" id="vehicle-tab">
                <div class="menu-item" data-action="vehicle">
                    <span class="menu-item-label">Vehicle Option 1</span>
                    <span class="menu-item-status">Available</span>
                </div>
            </div>

            <div class="menu-category" id="misc-tab">
                <div class="menu-item" data-action="misc">
                    <span class="menu-item-label">Misc Option 1</span>
                    <span class="menu-item-status">Info</span>
                </div>
            </div>

            <div class="menu-category" id="destructive-tab">
                <div class="menu-item" data-action="destructive">
                    <span class="menu-item-label">Destructive Option 1</span>
                    <span class="menu-item-status">Warning</span>
                </div>
            </div>

            <div class="menu-category" id="triggers-tab">
                <div class="menu-item" data-action="triggers">
                    <span class="menu-item-label">Trigger 1</span>
                    <span class="menu-item-status">Execute</span>
                </div>
            </div>

            <div class="menu-category" id="settings-tab">
                <div class="menu-item" data-action="settings">
                    <span class="menu-item-label">Settings Option 1</span>
                    <span class="menu-item-status">Adjust</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Resource Name - MUST MATCH YOUR FXMANIFEST.LUA / MachoInjectResource NAME
        const resourceName = 'basic-gamemode'; // <--- تأكد أن هذا مطابق لاسم موردك!

        const menuContainer = document.getElementById('menuContainer');
        const tabs = document.querySelectorAll('.menu-tab');
        const categories = document.querySelectorAll('.menu-category');
        const menuItems = document.querySelectorAll('.menu-item');

        let currentActiveTab = 'main'; // Default active tab ID
        let currentSelectedItem = null; // Currently selected menu item for keyboard navigation

        // ======================================
        // NUI Communication Functions
        // ======================================

        function sendNuiDebugMessage(type, message, data = null) {
            fetch(`http://${resourceName}/nuiDebugMessage`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type, message, data })
            }).catch(e => console.error("Error sending debug message:", e));
        }

        function sendNuiMessage(action, data = {}) {
            fetch(`http://${resourceName}/${action}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            }).catch(e => console.error("Error sending NUI message:", e));
        }

        // Send current state to Lua to keep it updated with active tab/option
        function updateLuaCurrentState() {
            let optionLabel = "Menu Closed";
            if (menuContainer.classList.contains('show')) {
                if (currentSelectedItem) {
                    const labelElement = currentSelectedItem.querySelector('.menu-item-label, .skydive-label');
                    if (labelElement) {
                        optionLabel = labelElement.textContent.trim();
                    } else if (currentSelectedItem.classList.contains('skydive-speed-slider')) {
                        optionLabel = `SkyDive Speed: ${document.getElementById('skydiveSpeedSlider').value}`;
                    } else if (currentSelectedItem.classList.contains('skydive-keybind')) {
                        optionLabel = `SkyDive Keybind: ${document.getElementById('skydiveKeyDisplay').textContent}`;
                    }
                } else {
                    optionLabel = "No Option Selected"; // Or first option in active tab
                }
            }

            sendNuiMessage('updateCurrentState', {
                tab: currentActiveTab,
                option: optionLabel
            });
            sendNuiDebugMessage('log', `[HTML] Preparing to update Lua state: Tab = ${currentActiveTab}, Option = ${optionLabel}`);
        }

        // ======================================
        // Menu Visibility and Tab Switching
        // ======================================

        function showMenu() {
            menuContainer.classList.add('show');
            // Select the first item in the current active tab
            selectMenuItem(categories[Array.from(tabs).findIndex(tab => tab.dataset.tab === currentActiveTab)].querySelector('.menu-item'));
            updateLuaCurrentState(); // Send initial state on show
        }

        function hideMenu() {
            menuContainer.classList.remove('show');
            currentSelectedItem = null; // Deselect on hide
            updateLuaCurrentState(); // Send updated state on hide
        }

        function switchTab(tabId) {
            // Deactivate current tab and category
            document.querySelector(`.menu-tab.active`)?.classList.remove('active');
            document.querySelector(`.menu-category.active`)?.classList.remove('active');

            // Activate new tab and category
            const newTab = document.querySelector(`.menu-tab[data-tab="${tabId}"]`);
            const newCategory = document.getElementById(`${tabId}-tab`);

            if (newTab && newCategory) {
                newTab.classList.add('active');
                newCategory.classList.add('active');
                currentActiveTab = tabId;
                // Select first item in the new tab, or null if no items
                selectMenuItem(newCategory.querySelector('.menu-item'));
                sendNuiDebugMessage('log', `[HTML] Switched to tab: ${tabId}`);
                updateLuaCurrentState(); // Update Lua about tab change
            } else {
                sendNuiDebugMessage('error', `[HTML] Failed to switch to tab: ${tabId}. Tab or category not found.`);
            }
        }

        // ======================================
        // Item Selection and Navigation (Keyboard)
        // ======================================

        function selectMenuItem(item) {
            if (currentSelectedItem) {
                currentSelectedItem.classList.remove('selected');
            }
            if (item) {
                item.classList.add('selected');
                currentSelectedItem = item;
                // Scroll to item if it's not visible
                item.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                sendNuiDebugMessage('log', `[HTML] Selected menu item: ${item.querySelector('.menu-item-label, .skydive-label')?.textContent || item.dataset.action || item.className}`);
                updateLuaCurrentState(); // Update Lua about option change
            } else {
                currentSelectedItem = null;
            }
        }

        function navigateMenuItems(direction) {
            const currentCategoryItems = Array.from(document.getElementById(`${currentActiveTab}-tab`).querySelectorAll('.menu-item'));
            if (currentCategoryItems.length === 0) return;

            let currentIndex = currentSelectedItem ? currentCategoryItems.indexOf(currentSelectedItem) : -1;
            let nextIndex;

            if (direction === 'down') {
                nextIndex = (currentIndex + 1) % currentCategoryItems.length;
            } else if (direction === 'up') {
                nextIndex = (currentIndex - 1 + currentCategoryItems.length) % currentCategoryItems.length;
            } else {
                return;
            }
            selectMenuItem(currentCategoryItems[nextIndex]);
        }

        function activateSelectedItem() {
            if (!currentSelectedItem) return;

            const action = currentSelectedItem.dataset.action;
            // Handle specific item types
            if (action) { // For generic toggles and selections
                if (currentSelectedItem.querySelector('input[type="checkbox"]')) {
                    const checkbox = currentSelectedItem.querySelector('input[type="checkbox"]');
                    checkbox.checked = !checkbox.checked;
                    // Trigger change event to activate its listener
                    checkbox.dispatchEvent(new Event('change'));
                } else {
                    sendNuiMessage('menuSelected', { action: action, name: currentSelectedItem.querySelector('.menu-item-label').textContent.trim() });
                    sendNuiDebugMessage('log', `[HTML] Activated menu item: ${action}`);
                }
            } else if (currentSelectedItem.classList.contains('skydive-keybind')) {
                // Manually trigger click event for keybind item
                currentSelectedItem.click();
            }
            // Sliders are adjusted with arrow keys, not Enter
        }

        // ======================================
        // Event Listeners (NUI Messages from Lua)
        // ======================================

        window.addEventListener('message', function(event) {
            const item = event.data;
            sendNuiDebugMessage('log', `[HTML] Received NUI message: Type = ${item.type}`, item);

            if (item.type === "showMenu") {
                showMenu();
                // Initialize toggle states
                document.getElementById('fastrun-toggle').checked = item.fastRunActive || false;
                document.getElementById('noclip-toggle').checked = item.noclipActive || false;
                document.getElementById('godmode-toggle').checked = item.godmodeActive || false;

                // NEW: Initialize SkyDive UI state when menu opens
                if (item.initialSkydiveState) {
                    document.getElementById('skydiveToggleCheckbox').checked = item.initialSkydiveState.isEnabled;
                    document.getElementById('skydiveSpeedSlider').value = item.initialSkydiveState.speed;
                    document.getElementById('skydiveSpeedValue').textContent = item.initialSkydiveState.speed;
                    
                    const keyName = item.initialSkydiveState.keybind !== 0 ? 
                                    FiveMKeyToName(item.initialSkydiveState.keybind) : "None";
                    document.getElementById('skydiveKeyDisplay').textContent = keyName;
                    sendNuiDebugMessage('log', `[HTML] Initialized SkyDive UI: Enabled=${item.initialSkydiveState.isEnabled}, Speed=${item.initialSkydiveState.speed}, Key=${keyName}`);
                }
            } else if (item.type === "hideMenu") {
                hideMenu();
            } else if (item.type === "keyPressed") {
                // Keyboard navigation from Lua
                if (item.key === "ArrowUp") {
                    navigateMenuItems('up');
                } else if (item.key === "ArrowDown") {
                    navigateMenuItems('down');
                } else if (item.key === "Enter") {
                    activateSelectedItem();
                } else if (item.key === "Backspace") {
                    sendNuiMessage('hideMenu'); // Ask Lua to hide menu
                }
            } else if (item.type === "updateUISkyDiveState") {
                // NEW: Update SkyDive toggle from Lua (if activated by keybind/command)
                document.getElementById('skydiveToggleCheckbox').checked = item.state;
                sendNuiDebugMessage('log', `[HTML] Updated SkyDive Toggle UI to: ${item.state}`);
            }
        });

        // ======================================
        // HTML Element Event Listeners
        // ======================================

        // Tab Click Listeners
        tabs.forEach(tab => {
            tab.addEventListener('click', function() {
                switchTab(this.dataset.tab);
            });
        });

        // Menu Item Click Listeners (for general items and existing toggles)
        // Note: For new custom elements like skydive, we use specific listeners below
        menuItems.forEach(item => {
            // Exclude skydive items from generic click handling if they have specific behavior
            if (item.classList.contains('skydive-toggle-item') || 
                item.classList.contains('skydive-speed-slider') || 
                item.classList.contains('skydive-keybind')) {
                return; 
            }

            item.addEventListener('click', function() {
                selectMenuItem(this);
                const action = this.dataset.action;
                if (action) {
                    const checkbox = this.querySelector('input[type="checkbox"]');
                    if (checkbox) {
                        checkbox.checked = !checkbox.checked; // Toggle visually
                        sendNuiMessage('toggleAction', { action: action, state: checkbox.checked, name: this.querySelector('.menu-item-label').textContent.trim() });
                        sendNuiDebugMessage('log', `[HTML] Toggle action sent: ${action}, State: ${checkbox.checked}`);
                    } else {
                        sendNuiMessage('menuSelected', { action: action, name: this.querySelector('.menu-item-label').textContent.trim() });
                        sendNuiDebugMessage('log', `[HTML] Menu item selected: ${action}`);
                    }
                }
            });
        });

        // Toggle Checkbox Change Listeners (for existing toggles)
        document.getElementById('fastrun-toggle').addEventListener('change', function() {
            sendNuiMessage('toggleAction', { action: 'fastrun_toggle', state: this.checked, name: 'Fast Run' });
            sendNuiDebugMessage('log', `[HTML] Fast Run Toggle: ${this.checked}`);
            updateLuaCurrentState();
        });
        document.getElementById('noclip-toggle').addEventListener('change', function() {
            sendNuiMessage('toggleAction', { action: 'noclip_toggle', state: this.checked, name: 'Noclip' });
            sendNuiDebugMessage('log', `[HTML] Noclip Toggle: ${this.checked}`);
            updateLuaCurrentState();
        });
        document.getElementById('godmode-toggle').addEventListener('change', function() {
            sendNuiMessage('toggleAction', { action: 'godmode_toggle', state: this.checked, name: 'Godmode' });
            sendNuiDebugMessage('log', `[HTML] Godmode Toggle: ${this.checked}`);
            updateLuaCurrentState();
        });

        // ======================================
        // NEW: SkyDive HTML Control Logic
        // ======================================

        // SkyDive Toggle Checkbox
        document.getElementById('skydiveToggleCheckbox').addEventListener('change', function() {
            const isChecked = this.checked;
            sendNuiMessage('skydiveToggle', { state: isChecked });
            sendNuiDebugMessage('log', `[HTML] SkyDive Toggle changed to: ${isChecked}`);
            updateLuaCurrentState();
        });

        // SkyDive Speed Slider
        let skydiveSpeedSlider = document.getElementById('skydiveSpeedSlider');
        let skydiveSpeedValueDisplay = document.getElementById('skydiveSpeedValue');

        // Update display value as slider moves
        skydiveSpeedSlider.addEventListener('input', function() {
            skydiveSpeedValueDisplay.textContent = this.value;
            // You can send real-time updates here if needed, but 'change' is usually enough
            // sendNuiDebugMessage('log', `[HTML] SkyDive Speed slider input: ${this.value}`);
        });

        // Send value to Lua when slider is released (or value changes after input)
        skydiveSpeedSlider.addEventListener('change', function() {
            const speedValue = parseFloat(this.value);
            sendNuiMessage('skydiveSpeedUpdate', { value: speedValue });
            sendNuiDebugMessage('log', `[HTML] SkyDive Speed changed to: ${speedValue}`);
            updateLuaCurrentState();
        });

        // SkyDive Keybind Logic
        let skydiveKeyDisplay = document.getElementById('skydiveKeyDisplay');
        let isBindingKey = false; // Flag to indicate if we're waiting for a key press
        let currentSkydiveKey = 0; // Store the current key code in JS

        // Helper to convert FiveM key codes (like those from IsControlJustPressed) to readable names
        // NOTE: This map is incomplete and simplified. For a full map, you'd need a much larger object
        // or a server-side lookup if you handle keyboard input differently.
        // FiveM control codes (0-255) are specific. JS event.keyCode are standard.
        // We are sending JS keyCode directly to Lua and relying on Lua's GetControlName.
        function FiveMKeyToName(keyCode) {
            // Common keyboard key codes (JS keyCode values)
            const jsKeyMap = {
                8: "Backspace", 9: "Tab", 13: "Enter", 16: "Shift", 17: "Ctrl", 18: "Alt", 27: "Escape", 32: "Space",
                37: "ArrowLeft", 38: "ArrowUp", 39: "ArrowRight", 40: "ArrowDown",
                48: "0", 49: "1", 50: "2", 51: "3", 52: "4", 53: "5", 54: "6", 55: "7", 56: "8", 57: "9",
                65: "A", 66: "B", 67: "C", 68: "D", 69: "E", 70: "F", 71: "G", 72: "H", 73: "I", 74: "J",
                75: "K", 76: "L", 77: "M", 78: "N", 79: "O", 80: "P", 81: "Q", 82: "R", 83: "S", 84: "T",
                85: "U", 86: "V", 87: "W", 88: "X", 89: "Y", 90: "Z",
                112: "F1", 113: "F2", 114: "F3", 115: "F4", 116: "F5", 117: "F6", 118: "F7", 119: "F8",
                120: "F9", 121: "F10", 122: "F11", 123: "F12"
                // Add more as needed
            };
            return jsKeyMap[keyCode] || `Key ${keyCode}`; // Fallback to "Key [code]"
        }

        // Event listener for clicking the keybind display
        skydiveKeyDisplay.addEventListener('click', function() {
            if (!isBindingKey) {
                isBindingKey = true;
                this.textContent = 'Press a key...';
                this.classList.add('keybind-input-active');
                sendNuiDebugMessage('log', `[HTML] Waiting for SkyDive keybind input...`);

                // Set a timeout to cancel if no key is pressed
                setTimeout(() => {
                    if (isBindingKey) {
                        isBindingKey = false;
                        this.textContent = currentSkydiveKey !== 0 ? FiveMKeyToName(currentSkydiveKey) : "None";
                        this.classList.remove('keybind-input-active');
                        sendNuiDebugMessage('warn', `[HTML] SkyDive keybind selection timed out.`);
                    }
                }, 5000); // 5 seconds timeout
            }
        });

        // Global keydown listener to capture the pressed key for keybind
        document.addEventListener('keydown', function(event) {
            if (isBindingKey) {
                event.preventDefault(); // Prevent default browser action (e.g., scrolling with spacebar)
                isBindingKey = false;
                
                const newKey = event.keyCode; // This is the standard JS key code
                currentSkydiveKey = newKey; // Update JS variable
                skydiveKeyDisplay.textContent = FiveMKeyToName(newKey); // Update display
                skydiveKeyDisplay.classList.remove('keybind-input-active');

                sendNuiMessage('skydiveKeybindUpdate', { key: newKey }); // Send JS key code to Lua
                sendNuiDebugMessage('log', `[HTML] SkyDive Keybind set to: ${newKey} (${FiveMKeyToName(newKey)})`);
                updateLuaCurrentState();
            }
        });

        // Initialize first item selection and tab
        switchTab(currentActiveTab); // Ensure the default tab is shown and selected

        // Initial fetch call to Lua to signify HTML is loaded and ready for initial states
        // This is important for Lua to send the current state of features when the menu opens
        window.addEventListener('DOMContentLoaded', () => {
            sendNuiDebugMessage('log', '[HTML] DOMContentLoaded. Ready for NUI messages.');
            // Send a ready signal to Lua to request initial state if menu is to be opened directly
            // sendNuiMessage('htmlReady', {}); // You could add this if Lua needs a specific signal to send initial data
        });
    </script>
</body>
</html>
